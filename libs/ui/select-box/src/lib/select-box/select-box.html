<div class="app-select-box-container" [class.has-error]="isInvalid">
    @if (label) {
    <label [for]="id" class="app-select-box-label">
        {{ label }}
        @if (required) {
        <span class="required-star">*</span>
        }
    </label>
    }

    <div class="select-box-container" [class.is-open]="isOpen()" [class.is-disabled]="disabled"
        [class.has-value]="!!selectedItem()" #trigger="cdkOverlayOrigin" #triggerContainer cdkOverlayOrigin
        (click)="toggleDropdown()">

        <div class="select-box-input-wrapper">
            <div class="select-box-content">
                @if (selectedItem()) {
                @if (fieldTemplate()) {
                <ng-container
                    *ngTemplateOutlet="fieldTemplate()!; context: { $implicit: selectedItem() }"></ng-container>
                } @else {
                <span class="selected-text">{{ getDisplayText(selectedItem()) }}</span>
                }
                } @else {
                <span class="placeholder">{{ placeholder() }}</span>
                }
            </div>

            <div class="select-box-actions">
                @if (clearableInput() && selectedItem() && !disabled) {
                <div class="action-btn clear-btn" (click)="clearValue($event)">
                    <i-lucide [img]="XIcon" [size]="16"></i-lucide>
                </div>
                }
                <div class="action-btn dropdown-btn">
                    <i-lucide [img]="ChevronDownIcon" [size]="18" [class.rotated]="isOpen()"></i-lucide>
                </div>
            </div>
        </div>
    </div>

    @if (hint) {
    <p class="app-select-box-hint">{{ hint }}</p>
    }

    @if (errorText && isInvalid) {
    <p class="app-select-box-error">{{ errorText }}</p>
    }
</div>

<ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="trigger" [cdkConnectedOverlayOpen]="isOpen()"
    [cdkConnectedOverlayPositions]="overlayPositions" [cdkConnectedOverlayWidth]="overlayWidth"
    [cdkConnectedOverlayScrollStrategy]="scrollStrategy()" (overlayOutsideClick)="closeDropdown()"
    (detach)="closeDropdown()">

    <div class="select-box-dropdown" (keydown)="handleKeydown($event)">
        @if (searchEnabled()) {
        <div class="search-container">
            <i-lucide [img]="SearchIcon" [size]="16" class="search-icon"></i-lucide>
            <input #searchInput type="text" class="search-input" [placeholder]="searchPlaceholder()"
                (input)="handleSearch($event)" (keydown)="handleSearchKeydown($event)" />
        </div>
        }

        <div class="list-container">
            @if (loading() && items().length === 0) {
            <div class="loading-state">
                <div class="spinner"></div>
                <span>Loading...</span>
            </div>
            } @else if (items().length === 0 && !loading()) {
            <div class="no-data-state">
                <span>No data found</span>
            </div>
            }

            <cdk-virtual-scroll-viewport [itemSize]="36" [minBufferPx]="200" [maxBufferPx]="400"
                [style.height.px]="viewportHeight" class="viewport" (scrolledIndexChange)="onScrollIndexChange($event)">

                <div *cdkVirtualFor="let item of flattenedItems(); let i = index; trackBy: trackById" class="list-item"
                    [class.group-header]="isGroupHeader(item)" [class.is-selected]="isSelected(item)"
                    [class.is-focused]="focusedIndex() === i"
                    (click)="isGroupHeader(item) ? toggleGroup(item.__groupKey, $event) : selectItem(item)">

                    @if (isGroupHeader(item)) {
                    <div class="group-header-content">
                        <div class="group-expand-icon" [class.expanded]="item.__expanded">
                            <i-lucide [img]="ChevronDownIcon" [size]="14"></i-lucide>
                        </div>
                        @if (groupTemplate()) {
                        <ng-container *ngTemplateOutlet="groupTemplate()!; context: { $implicit: item }"></ng-container>
                        } @else {
                        <span class="group-title">{{ item.__groupKey }}</span>
                        <span class="group-count">({{ item.__count }})</span>
                        }
                    </div>
                    } @else {
                    <div class="item-content" [class.in-group]="groupExpr()">
                        @if (itemTemplate()) {
                        <ng-container
                            *ngTemplateOutlet="itemTemplate()!; context: { $implicit: item, index: i }"></ng-container>
                        } @else {
                        {{ getDisplayText(item) }}
                        }
                    </div>
                    }
                </div>

                @if (loading() && items().length > 0) {
                <div class="loading-more">
                    <div class="spinner small"></div>
                    <span>Loading more...</span>
                </div>
                }
            </cdk-virtual-scroll-viewport>
        </div>
    </div>
</ng-template>